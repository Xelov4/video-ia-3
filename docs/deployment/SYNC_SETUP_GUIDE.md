# üîÑ Guide de Configuration Synchronisation WSL ‚Üî VPS

Guide complet pour mettre en place la synchronisation bidirectionnelle entre votre environnement de d√©veloppement WSL et le VPS de production.

---

## üìã Table des Mati√®res

1. [Vue d'ensemble](#vue-densemble)
2. [Pr√©requis](#pr√©requis)
3. [Configuration initiale](#configuration-initiale)
4. [Scripts de synchronisation](#scripts-de-synchronisation)
5. [GitHub Actions](#github-actions)
6. [Utilisation quotidienne](#utilisation-quotidienne)
7. [D√©pannage](#d√©pannage)

---

## üéØ Vue d'ensemble

### Architecture de synchronisation
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   WSL (DEV)     ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ    GitHub       ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ   VPS (PROD)    ‚îÇ
‚îÇ localhost:5432  ‚îÇ    ‚îÇ   Repository    ‚îÇ    ‚îÇ46.202.129.104   ‚îÇ
‚îÇ video_ia_user   ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ video_ia_user   ‚îÇ
‚îÇ password:       ‚îÇ    ‚îÇ Actions CI/CD   ‚îÇ    ‚îÇ password:       ‚îÇ
‚îÇ video123        ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ Buzzerbeater23  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                       ‚îÇ                       ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ Synchronisation ‚îÇ
                    ‚îÇ Bidirectionnelle‚îÇ
                    ‚îÇ   - Code Git    ‚îÇ
                    ‚îÇ - Base donn√©es  ‚îÇ
                    ‚îÇ   - Assets      ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Types de synchronisation disponibles
- **üîÑ dev-to-prod**: WSL ‚Üí VPS (d√©ploiement)
- **üîÑ prod-to-dev**: VPS ‚Üí WSL (r√©cup√©ration analytics)
- **üîÑ full-sync**: Synchronisation compl√®te bidirectionnelle
- **üì¶ quick-deploy**: D√©ploiement rapide code + DB

---

## ‚úÖ Pr√©requis

### Sur WSL (Environnement de d√©veloppement)
```bash
# V√©rifier Node.js
node --version  # >= 18.0.0

# V√©rifier PostgreSQL
psql --version  # >= 12.0

# V√©rifier Git
git --version   # >= 2.30

# Installer sshpass si n√©cessaire
sudo apt-get install sshpass

# V√©rifier la connexion √† votre DB locale
PGPASSWORD=video123 psql -h localhost -U video_ia_user -d video_ia_net -c "SELECT COUNT(*) FROM tools;"
```

### Sur le VPS (Production)
```bash
# SSH vers le VPS pour v√©rifier
ssh root@46.202.129.104

# V√©rifier les services
systemctl status postgresql
systemctl status nginx
pm2 status

# V√©rifier la base de donn√©es
PGPASSWORD=Buzzerbeater23 psql -h localhost -U video_ia_user -d video_ia_net -c "SELECT COUNT(*) FROM tools;"
```

---

## üîß Configuration initiale

### 1. Configuration des variables d'environnement

Cr√©er le fichier `.env.sync` :
```bash
# Dans le r√©pertoire racine du projet
cat > .env.sync << 'EOF'
# Development Database
DEV_DB_HOST=localhost
DEV_DB_PORT=5432
DEV_DB_NAME=video_ia_net
DEV_DB_USER=video_ia_user
DEV_DB_PASSWORD=video123

# Production Database
PROD_DB_HOST=46.202.129.104
PROD_DB_PORT=5432
PROD_DB_NAME=video_ia_net
PROD_DB_USER=video_ia_user
PROD_DB_PASSWORD=Buzzerbeater23

# VPS Access
VPS_HOST=46.202.129.104
VPS_USER=root
VPS_PASSWORD=Buzzerbeater23
EOF
```

### 2. Configuration GitHub Secrets

Dans votre repository GitHub (Settings > Secrets and Variables > Actions) :

```bash
# Secrets requis
VPS_PASSWORD=Buzzerbeater23
PROD_DB_PASSWORD=Buzzerbeater23
```

### 3. Test de connectivit√©

```bash
# Test de toutes les connexions
npm run sync:analyze
```

---

## üìú Scripts de synchronisation

### Script principal : Synchronisation bidirectionnelle
```bash
# Synchronisation DEV ‚Üí PROD (d√©ploiement)
npm run sync:dev-to-prod

# Synchronisation PROD ‚Üí DEV (r√©cup√©ration donn√©es)
npm run sync:prod-to-dev

# Synchronisation compl√®te bidirectionnelle
npm run sync:full

# Modes avanc√©s
node scripts/deploy/sync-bidirectional.js --mode=dev-to-prod --dry-run
node scripts/deploy/sync-bidirectional.js --mode=prod-to-dev --skip-git
```

### Script de d√©ploiement rapide
```bash
# D√©ploiement complet (code + DB)
npm run deploy:quick

# D√©ploiement code seulement
./scripts/deploy/quick-deploy.sh --skip-db

# Preview des actions (dry run)
./scripts/deploy/quick-deploy.sh --dry-run

# D√©ploiement sans rebuild
./scripts/deploy/quick-deploy.sh --skip-build
```

### Scripts existants am√©lior√©s
```bash
# Synchronisation DB DEV ‚Üí PROD
npm run sync:to-prod -- --mode=tools --dry-run

# Synchronisation DB PROD ‚Üí DEV
npm run sync:from-prod -- --mode=analytics-only

# Analyse des diff√©rences entre bases
npm run sync:analyze -- --verbose

# Dashboard interactif
npm run sync:dashboard
```

---

## ‚öôÔ∏è GitHub Actions

### 1. D√©ploiement automatique (`.github/workflows/deploy-to-vps.yml`)

**D√©clenchement :**
- Push sur `main` (automatique)
- Manuel via GitHub UI

**Options disponibles :**
- `deployment_type`: full, code-only, db-only, restart-only
- `skip_backup`: Ignorer la cr√©ation de backup
- `dry_run`: Preview sans modifications

**Usage manuel :**
1. Aller sur GitHub > Actions
2. S√©lectionner "üöÄ Deploy to VPS"
3. Cliquer "Run workflow"
4. Choisir les options et "Run workflow"

### 2. Synchronisation DB (`.github/workflows/sync-databases.yml`)

**D√©clenchement :**
- Manuel via GitHub UI
- Programm√© quotidiennement √† 02:00 UTC

**Options disponibles :**
- `sync_direction`: dev-to-prod, prod-to-dev, bidirectional
- `sync_mode`: full, content-only, tools-only, categories-only, analytics-only
- `dry_run`: Preview seulement
- `preserve_analytics`: Pr√©server les analytics de production

**Usage :**
1. GitHub > Actions > "üîÑ Database Synchronization"
2. "Run workflow"
3. Configurer les options
4. "Run workflow"

---

## üîÑ Utilisation quotidienne

### Workflow de d√©veloppement recommand√©

#### 1. D√©veloppement local
```bash
# 1. D√©velopper en local
npm run dev

# 2. Tester vos changements
npm run type-check
npm run test:database

# 3. Commiter vos changements
git add .
git commit -m "feat: nouvelles fonctionnalit√©s"
```

#### 2. D√©ploiement rapide
```bash
# Option A: D√©ploiement automatique complet
npm run deploy:quick

# Option B: D√©ploiement via GitHub Actions
git push origin main  # D√©clenche le d√©ploiement automatique
```

#### 3. R√©cup√©ration des analytics production
```bash
# R√©cup√©rer les stats de production vers d√©veloppement
npm run sync:prod-to-dev

# Ou seulement les analytics
node scripts/deploy/sync-bidirectional.js --mode=prod-to-dev --skip-git
```

### Workflows sp√©cialis√©s

#### Mise √† jour de contenu important
```bash
# 1. Backup des deux environnements
npm run sync:analyze  # Voir les diff√©rences

# 2. Synchronisation avec backup
npm run sync:dev-to-prod  # Auto-backup inclus

# 3. Validation
curl -s https://www.video-ia.net/api/tools?limit=5 | jq '.'
```

#### R√©cup√©ration d'urgence
```bash
# Si probl√®me sur DEV, r√©cup√©rer depuis PROD
npm run sync:prod-to-dev

# Ou plus s√©lectif
node scripts/deploy/sync-bidirectional.js --mode=prod-to-dev --skip-git --backup
```

---

## üß™ Tests et validation

### Tests de connectivit√©
```bash
# Test complet des connexions
npm run sync:analyze

# Test endpoint DEV
curl -s http://localhost:3000/api/tools?limit=1

# Test endpoint PROD
curl -s https://www.video-ia.net/api/tools?limit=1
```

### Validation des donn√©es
```bash
# Comparer les bases de donn√©es
npm run validate:databases

# Voir les diff√©rences d√©taill√©es
npm run sync:analyze -- --compare-all --verbose --output=analysis.json
```

### Tests de d√©ploiement
```bash
# Test complet du d√©ploiement en dry run
./scripts/deploy/quick-deploy.sh --dry-run

# Test de l'infrastructure VPS
npm run test:deployment
```

---

## üö® D√©pannage

### Probl√®mes de connectivit√©

#### Connexion DB √©choue
```bash
# Test manuel des connexions
PGPASSWORD=video123 psql -h localhost -U video_ia_user -d video_ia_net -c "SELECT 1;"
PGPASSWORD=Buzzerbeater23 psql -h 46.202.129.104 -U video_ia_user -d video_ia_net -c "SELECT 1;"

# V√©rifier les ports
netstat -tulnp | grep 5432
```

#### SSH vers VPS √©choue
```bash
# Test manuel SSH
sshpass -p "Buzzerbeater23" ssh -o ConnectTimeout=10 root@46.202.129.104 "echo 'OK'"

# V√©rifier la connectivit√©
ping 46.202.129.104
nc -zv 46.202.129.104 22
```

### Probl√®mes de synchronisation

#### Synchronisation DB interrompue
```bash
# V√©rifier l'√©tat des transactions
npm run sync:analyze -- --check-locks

# Restaurer depuis backup si n√©cessaire
BACKUP_FILE=$(ls -1t backups/sync/backup_prod_*.sql | head -1)
PGPASSWORD=Buzzerbeater23 psql -h 46.202.129.104 -U video_ia_user -d video_ia_net -f "$BACKUP_FILE"
```

#### Diff√©rences importantes entre bases
```bash
# Analyse d√©taill√©e
npm run sync:analyze -- --verbose --output=diff-report.json

# Voir le rapport
cat diff-report.json | jq '.recommendations'

# Sync selective si n√©cessaire
node scripts/deploy/sync-bidirectional.js --mode=dev-to-prod --tables="tools,categories"
```

### Probl√®mes de d√©ploiement

#### Application ne red√©marre pas sur VPS
```bash
# SSH sur VPS et debug
ssh root@46.202.129.104

# V√©rifier PM2
pm2 status
pm2 logs video-ia-net --lines 50

# Restart manuel si n√©cessaire
pm2 restart video-ia-net
```

#### Build √©choue
```bash
# Test build local
npm run build

# V√©rifier les types
npm run type-check

# Nettoyer et r√©essayer
rm -rf .next node_modules
npm ci
npm run build
```

---

## üìä Monitoring et logs

### Logs disponibles
```bash
# Logs de synchronisation
ls -la logs/sync-report-*.json

# Logs PM2 sur VPS
ssh root@46.202.129.104 'pm2 logs video-ia-net --lines 100'

# Logs syst√®me VPS
ssh root@46.202.129.104 'tail -f /var/log/video-ia-monitor.log'
```

### M√©triques importantes
```bash
# Stats des bases de donn√©es
npm run sync:analyze -- --stats-only

# Performance des endpoints
curl -w "@curl-format.txt" -o /dev/null -s https://www.video-ia.net/api/tools?limit=1
```

---

## ‚ö° Commandes rapides

### Setup one-time
```bash
# Configuration compl√®te du VPS
npm run deploy:vps-setup

# Premier d√©ploiement
npm run deploy:migrate-initial
```

### Usage quotidien
```bash
# D√©ploiement rapide
npm run deploy:quick

# R√©cup√©ration analytics
npm run sync:prod-to-dev

# V√©rification √©tat
npm run sync:analyze
```

### Debug
```bash
# Logs d√©taill√©s
npm run sync:dashboard

# Test connectivit√©
npm run validate:databases

# Backup manuel
node scripts/deploy/sync-bidirectional.js --mode=dev-to-prod --dry-run
```

---

## üéØ Bonnes pratiques

### Avant chaque d√©ploiement
1. ‚úÖ Tester localement avec `npm run dev`
2. ‚úÖ V√©rifier les types avec `npm run type-check`
3. ‚úÖ Commiter tous les changements
4. ‚úÖ Analyser les diff√©rences avec `npm run sync:analyze`

### Synchronisation de donn√©es
1. üîÑ Pr√©f√©rer `dev-to-prod` pour le contenu
2. üîÑ Utiliser `prod-to-dev` pour r√©cup√©rer les analytics
3. üîÑ Toujours cr√©er des backups pour les op√©rations importantes
4. üîÑ Utiliser `dry-run` pour pr√©visualiser les changements

### S√©curit√©
1. üîê Ne jamais commiter les mots de passe
2. üîê Utiliser GitHub Secrets pour les credentials
3. üîê V√©rifier les backups avant les op√©rations destructives
4. üîê Monitorer les logs apr√®s chaque d√©ploiement

---

**üéâ Votre syst√®me de synchronisation est maintenant op√©rationnel !**

Pour toute question, r√©f√©rez-vous √† ce guide ou utilisez les commandes de debug disponibles.