name: ğŸ”„ Sync Database DEV â†’ PROD

on:
  workflow_dispatch:
    inputs:
      sync_mode:
        description: 'Sync mode'
        type: choice
        options: 
          - 'full'      # All content tables
          - 'tools'     # Tools only
          - 'categories' # Categories only
          - 'translations' # Translations only
          - 'selective'  # Selective tables
        default: 'full'
        required: true
      
      tables_to_sync:
        description: 'Tables to sync (for selective mode, comma-separated)'
        type: string
        default: 'tools,categories,tool_translations,category_translations'
        required: false
      
      dry_run:
        description: 'Dry run (preview changes without applying)'
        type: boolean
        default: true
        required: false
      
      preserve_analytics:
        description: 'Preserve production analytics (view_count, etc.)'
        type: boolean
        default: true
        required: false
      
      backup_before_sync:
        description: 'Create backup before sync'
        type: boolean
        default: true
        required: false

jobs:
  pre_sync_validation:
    name: Pre-Sync Validation
    runs-on: ubuntu-latest
    outputs:
      dev_tools_count: ${{ steps.count_dev.outputs.count }}
      prod_tools_count: ${{ steps.count_prod.outputs.count }}
      can_proceed: ${{ steps.validate.outputs.can_proceed }}
      
    steps:
      - name: ğŸ“‹ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ” Count DEV Tools
        id: count_dev
        run: |
          count=$(PGPASSWORD="${{ secrets.DEV_DB_PASSWORD }}" psql -h "${{ secrets.DEV_DB_HOST }}" -U "${{ secrets.DEV_DB_USER }}" -d "${{ secrets.DEV_DB_NAME }}" -t -c "SELECT COUNT(*) FROM tools WHERE is_active = true;")
          echo "count=$count" >> $GITHUB_OUTPUT
          echo "ğŸ“Š DEV Database: $count active tools"

      - name: ğŸ” Count PROD Tools  
        id: count_prod
        run: |
          count=$(PGPASSWORD="${{ secrets.PROD_DB_PASSWORD }}" psql -h "${{ secrets.PROD_DB_HOST }}" -U "${{ secrets.PROD_DB_USER }}" -d "${{ secrets.PROD_DB_NAME }}" -t -c "SELECT COUNT(*) FROM tools WHERE is_active = true;")
          echo "count=$count" >> $GITHUB_OUTPUT
          echo "ğŸ“Š PROD Database: $count active tools"

      - name: âœ… Validate Sync Conditions
        id: validate
        run: |
          dev_count="${{ steps.count_dev.outputs.count }}"
          prod_count="${{ steps.count_prod.outputs.count }}"
          
          # Remove whitespace
          dev_count=$(echo $dev_count | tr -d ' ')
          prod_count=$(echo $prod_count | tr -d ' ')
          
          echo "ğŸ“Š Validation Results:"
          echo "- DEV: $dev_count tools"
          echo "- PROD: $prod_count tools"
          
          # Safety checks
          if [ "$dev_count" -lt 1000 ]; then
            echo "âŒ DEV database seems too small ($dev_count < 1000)"
            echo "can_proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Calculate difference percentage
          if [ "$prod_count" -gt 0 ]; then
            diff=$((dev_count - prod_count))
            abs_diff=${diff#-}  # Absolute value
            percent=$((abs_diff * 100 / prod_count))
            
            if [ "$percent" -gt 50 ]; then
              echo "âš ï¸ Large difference detected: ${percent}% ($diff tools)"
              echo "This will be noted but sync can proceed"
            fi
          fi
          
          echo "âœ… Sync validation passed"
          echo "can_proceed=true" >> $GITHUB_OUTPUT

  sync_database:
    name: Sync Database
    runs-on: ubuntu-latest
    needs: pre_sync_validation
    if: needs.pre_sync_validation.outputs.can_proceed == 'true'
    
    steps:
      - name: ğŸ“‹ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ“¦ Backup Production Database
        if: ${{ inputs.backup_before_sync }}
        run: |
          echo "ğŸ“¦ Creating production backup..."
          BACKUP_FILE="backup_prod_$(date +%Y%m%d_%H%M%S).sql"
          PGPASSWORD="${{ secrets.PROD_DB_PASSWORD }}" pg_dump \
            -h "${{ secrets.PROD_DB_HOST }}" \
            -U "${{ secrets.PROD_DB_USER }}" \
            -d "${{ secrets.PROD_DB_NAME }}" \
            --clean --if-exists \
            -f "$BACKUP_FILE"
          
          echo "âœ… Backup created: $BACKUP_FILE"
          echo "ğŸ“Š Backup size: $(du -h $BACKUP_FILE | cut -f1)"

      - name: ğŸ”„ Execute Database Sync
        run: |
          echo "ğŸš€ Starting database sync DEV â†’ PROD"
          echo "Mode: ${{ inputs.sync_mode }}"
          echo "Dry run: ${{ inputs.dry_run }}"
          echo "Preserve analytics: ${{ inputs.preserve_analytics }}"
          
          # Run the sync script
          npm run sync:to-prod -- \
            --mode="${{ inputs.sync_mode }}" \
            --tables="${{ inputs.tables_to_sync }}" \
            ${{ inputs.dry_run && '--dry-run' || '' }} \
            ${{ inputs.preserve_analytics && '--preserve-analytics' || '' }}

      - name: ğŸ” Post-Sync Validation
        if: ${{ !inputs.dry_run }}
        run: |
          echo "ğŸ” Validating sync results..."
          
          # Count tools after sync
          new_count=$(PGPASSWORD="${{ secrets.PROD_DB_PASSWORD }}" psql -h "${{ secrets.PROD_DB_HOST }}" -U "${{ secrets.PROD_DB_USER }}" -d "${{ secrets.PROD_DB_NAME }}" -t -c "SELECT COUNT(*) FROM tools WHERE is_active = true;")
          new_count=$(echo $new_count | tr -d ' ')
          
          echo "ğŸ“Š Post-sync PROD tools: $new_count"
          echo "ğŸ“Š Original DEV tools: ${{ needs.pre_sync_validation.outputs.dev_tools_count }}"
          
          # Basic validation
          if [ "$new_count" -lt 1000 ]; then
            echo "âŒ Post-sync validation failed: too few tools"
            exit 1
          fi
          
          echo "âœ… Post-sync validation passed"

      - name: ğŸ“Š Sync Summary
        if: always()
        run: |
          echo "## ğŸ”„ Database Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Direction**: DEV â†’ PROD" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode**: ${{ inputs.sync_mode }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run**: ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **DEV Tools**: ${{ needs.pre_sync_validation.outputs.dev_tools_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PROD Tools (before)**: ${{ needs.pre_sync_validation.outputs.prod_tools_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "- **Note**: This was a dry run - no changes applied" >> $GITHUB_STEP_SUMMARY
          fi